# Trabajo del dia 29 de marzo de 2017

## Reversion de retiro

Se actualizo el procedimiento EvoData.gt.reversa_retiros

```sql
--Linea Orginal
update exp.emp_empleos 
        set emp_Estado = 'A', emp_fecha_retiro = null, emp_codcmr = null, emp_codmrt = NULL
         where emp_codigo = @codemp

--Linea nueva
update exp.emp_empleos 
        set emp_Estado = 'A', emp_fecha_retiro = null, emp_codcmr = null, emp_codmrt = NULL, emp_estado_activo = 'A'
         where emp_codigo = @codemp
```

Fue probado por Yarkelis y funciono correctamente

## Integraci√≥n Observer

Se realizaron los procedimientos almacenados de 

### Encabezado de nomina

```sql
alter procedure [sal].[ConsultaEncabezadoAsientos]
@ppl_codigo_planilla varchar(30)
as 
BEGIN
select  ppl_codigo_planilla 'Ref1'
        ,CONVERT(varchar(15), fecha_asiento, 112) 'RefDate'
        ,tpl_descripcion 'Memo'
        ,'PLN' 'TransCode'
        ,CONVERT(varchar(15), fecha_asiento, 112) 'TaxDate'
from sal.asientos_de_nomina_v
where ppl_codigo_planilla = @ppl_codigo_planilla
End
```
### Detalle de nomina

```sql
CREATE procedure [sal].[ConsultaDetalleAsientos]
@ppl_codigo_planilla varchar(30)
as 
BEGIN
SELECT  -1 + ROW_NUMBER() OVER (partition by ppl_codigo_planilla order by ppl_fecha_pago) 'LineNum'
        ,CASE WHEN GROUPING_id((cuenta), (abreviatura), (ppl_codigo_planilla), (cco_abreviatura), (tipo), (tpl_descripcion), (descripcion_tipo), (ppl_fecha_ini), (ppl_fecha_fin), (ppl_fecha_pago)) = 0 THEN cuenta 
			ELSE '2010206' END 'Account'
        ,CASE 
			WHEN GROUPING_id((cuenta), (abreviatura), (ppl_codigo_planilla), (cco_abreviatura), (tipo), (tpl_descripcion), (descripcion_tipo), (ppl_fecha_ini), (ppl_fecha_fin), (ppl_fecha_pago)) = 0 
			THEN 
				SUM(
				CASE 
					WHEN tipo = 'I' or tipo = 'RP' THEN valor 
					ELSE 0 END 
				)
			ELSE 0 END 'Debit'
        ,CASE 
			WHEN GROUPING_id((cuenta), (abreviatura), (ppl_codigo_planilla), (cco_abreviatura), (tipo), (tpl_descripcion), (descripcion_tipo), (ppl_fecha_ini), (ppl_fecha_fin), (ppl_fecha_pago)) = 0 
			THEN
				SUM( 
				CASE 
					WHEN tipo = 'D' or tipo = 'R'
						THEN valor
					ELSE 0 END 
				)
			ELSE
				SUM( 
				CASE 
					WHEN tipo = 'I' 
						THEN valor 
					WHEN tipo = 'D' 
						THEN -valor 
					ELSE 0 end 
				)
		END 'Credit'
        ,CASE WHEN GROUPING_id((cuenta), (abreviatura), (ppl_codigo_planilla), (cco_abreviatura), (tipo), (tpl_descripcion), (descripcion_tipo), (ppl_fecha_ini), (ppl_fecha_fin), (ppl_fecha_pago)) = 0 THEN 'MONTO POR ' + abreviatura + ' ' + tpl_descripcion ELSE 'DEVENGADO EN PLANILLA ' + tpl_descripcion end 'LineMemo'
        ,case when tipo_planilla in ('X01','X06','X03','X05','X02') then case when cco_abreviatura = '000' then '000' else cco_abreviatura end  else cco_abreviatura end 'ProfitCode'
FROM sal.asientos_de_nomina_v
where ppl_codigo_planilla = @ppl_codigo_planilla
GROUP BY 
GROUPING SETS((cuenta, abreviatura, descripcion_tipo, ppl_codigo_planilla, cco_abreviatura, tipo, tpl_descripcion, ppl_fecha_ini, ppl_fecha_fin, ppl_fecha_pago, tipo_planilla), (ppl_codigo_planilla, cco_abreviatura, ppl_fecha_ini, ppl_fecha_fin, ppl_fecha_pago, ppl_codigo_planilla, tipo_planilla, tpl_descripcion ))
order BY LineNum asc, tipo ASC
End
```

### Encabezado de transferencia
Es el mismo que el encabezado de nomina

### Consulta Asientos Nomina

```sql
alter PROCEDURE [sal].[ConsultaAsientosNomina]
	AS
    BEGIN
SELECT  no_de_nomina as NUMERO_NOMINA
, tipo_planilla as NOMINA
, tpl_descripcion as DESCRIPCION
, ppl_codigo_planilla AS ASIENTO
, cco_abreviatura AS CTR_NOMINA
, CONVERT(varchar(15), ppl_fecha_ini, 103) AS FECHA_INICIO
, CONVERT(varchar(15), ppl_fecha_fin, 103) AS FECHA_FIN
, CONVERT(varchar(15), fecha_asiento, 103) AS FECHA_DIARIO
FROM sal.asientos_de_nomina_v
END
```

### Consulta Asientos Transferencia

```sql
create PROCEDURE [sal].[ConsultaAsientosTransf]
	AS
    BEGIN
SELECT	tipo_planilla as NOMINA
		, tpl_descripcion as DESCRIPCION
		, ppl_codigo_planilla AS ASIENTO
		, sum(case when tipo = 'I' then valor when tipo = 'D' then -1 * valor else 0 end) as NETO
		, CONVERT(varchar(15), ppl_fecha_pago, 103) AS FECHA_DIARIO
FROM sal.asientos_de_nomina_v
group by tipo_planilla,ppl_codigo_planilla, tpl_descripcion, ppl_codigo_planilla, CONVERT(varchar(15), ppl_fecha_pago, 103)
END
```

### Tabla de registro
Esta tabla fue solicitada por Oscar para almacenar las respuestas de SAP cuando se cargan los datos

```sql
CREATE TABLE [sal].[ControlAsientos](
	[IDASIENTO] [int] IDENTITY(1,1) NOT NULL,
	[ASIENTO] [varchar](10) NOT NULL,
	[FECHA_ASIENTO] [datetime] NOT NULL,
	[FECHA_GENERA] [datetime] NULL,
	[REFERENCIA_SAP] [numeric](10, 0) NULL,
	[GENERADO] [bit] NULL,
	[TIPO_ASIENTO] [varchar](2) NULL,
	[VECES_GENERADO] [numeric](8, 0) NULL,
	[USUARIO_ASIENTO] [varchar](20) NULL,
	[ERROR_ASIENTO] [bit] NULL,
	[MENSAJE] [varchar](256) NULL,
	[IPADDRESS] [varchar](14) NULL,
	[HOSTNAME] [varchar](50) NULL,
 CONSTRAINT [PK_ControlAsientos] PRIMARY KEY CLUSTERED 
(
	[ASIENTO] ASC,
	[FECHA_ASIENTO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

```

### Requerimientos de desarrollo
Oscar solicito los nuevos desarrollos, para cheques de asociados, transferencia de acreedores y cheques de acreedores
